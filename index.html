<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>

  <title>ewindisch/nova @ GitHub</title>

  <style type="text/css">
    body {
      margin-top: 1.0em;
      background-color: #FFFFFF;
      font-family: Helvetica, Arial, FreeSans, san-serif;
      color: black;
    }
    #container {
      margin: 0 auto;
      width: 700px;
    }
    h1 { font-size: 3.8em; color: #a759b4; margin-bottom: 3px; }
    h1 .small { font-size: 0.4em; }
    h1 a { text-decoration: none }
    h2 { font-size: 1.5em; color: black; }
    h3 { text-align: left; color: gray; }
    a { color: #a759b4; }
    .description { font-size: 1.2em; margin-bottom: 30px; margin-top: 30px; font-style: italic;}
    .download { float: right; }
    pre { background: #000; color: #fff; padding: 15px;}
    hr { border: 0; width: 80%; border-bottom: 1px solid #aaa}
    .footer { text-align:center; padding-top:30px; font-style: italic; }
  </style>
</head>

<body>
  <a href="https://github.com/ewindisch/nova"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub" /></a>

  <div id="container">

    <div class="download">
      <a href="https://github.com/ewindisch/nova/zipball/master">
        <img border="0" width="90" src="https://github.com/images/modules/download/zip.png"></a>
      <a href="https://github.com/ewindisch/nova/tarball/master">
        <img border="0" width="90" src="https://github.com/images/modules/download/tar.png"></a>
    </div>

    
<h1 class="c0"><span>OpenStack Nova ZeroMQ RPC Driver</span></h1><p
class="c0"><span class="c12" style="font-size: 2em;"><b>Deployment guide</b></span><sup><a href="#cmnt1" name="cmnt_ref1">[a]</a></sup></p><hr><p class="c0 c2"><span class="c7"></span></p><h2 class="c0"><span>Abstract</span></h2><p class="c0 c2"><span></span></p><p class="c0"><span>With Folsom, Nova introduces an optional messaging system using</span><span><a class="c4" href="http://zguide.zeromq.org/">&nbsp;</a></span><span class="c9"><a class="c4" href="http://zguide.zeromq.org/">ZeroMQ</a></span><span>. &nbsp;For some Nova deployments it may be desirable to use a broker-less RPC mechanism. &nbsp;This document provides deployment information for this driver.</span></p><p class="c0 c2"><span></span></p><p class="c0"><span>Topics are used to identify the destination for an RPC call. There are two types of topics, bare topics and directed topics. &nbsp;Bare topics look like &ldquo;</span><span class="c5">compute</span><span>&rdquo; , while directed topics look like &ldquo;</span><span class="c5">compute.machine1</span><span>&rdquo;.</span></p><p class="c0 c2"><span></span></p><h2 class="c0"><a name="h.q7gb0r159u5v"></a><span>Enabling</span></h2><p class="c0 c2"><span></span></p><p class="c0"><span>To enable the driver, the &lsquo;rpc_backend&rsquo; flag must be passed to each Nova service. The value of this flag should be &lsquo;nova.rpc.impl_zmq&rsquo;.</span></p><p class="c0 c2"><span class="c7 c11"></span></p><h2 class="c0"><a name="h.7etdviov1mae"></a><span>DNS</span></h2><p class="c0 c2"><span></span></p><p class="c0"><span>All TCP connections are made to hostnames. To specify, these are hostnames, not FQDNs. Host resolution is mandatory. The best practice is to deploy viable nameservers which can resolve all hostnames in the cloud under a single domain. Machines should then have dns search domain to resolve the bare hostnames.</span></p><p class="c0 c2"><span></span></p><p class="c0"><span>i.e.</span></p><h3 class="c0"><a name="h.o158xidbcvru"></a><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dns zone for </span><span class="c9"><a class="c4" href="http://lab.example.com">lab.example.com</a></span><span>&nbsp;on 192.168.1.1</span></h3><p class="c0"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c1p509 IN A 192.168.2.1</span></p><p class="c0 c2"><span></span></p><h3 class="c0"><a name="h.guxjceri71mx"></a><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resolv.conf:</span></h3><p class="c0"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;search </span><span class="c9"><a class="c4" href="http://lab.example.com">lab.example.com</a></span></p><p class="c0"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nameserver 192.168.1.1</span></p><h2 class="c0"><span>Match Making</span></h2><p class="c0 c2"><span></span></p><p class="c0"><span>The ZeroMQ driver implements a matching capability to discover hosts available for communication when sending to a bare topic. This allows broker-less communications.</span></p><p class="c0 c2"><span></span></p><p class="c0"><span>The MatchMaker is pluggable and may also be used to enforce sending messages through a </span><span class="c5">BROKER</span><span>.</span></p><p class="c0 c2"><span></span></p><p class="c0"><span>This driver provides four MatchMaker classes in the Essex release:</span><sup><a href="#cmnt2" name="cmnt_ref2">[b]</a></sup></p><ol class="c8" start="1"><li class="c0 c6"><span>MatchMakerBroker - forces all bare topics through a broker. (</span><span class="c7">DEFAULT</span><span>)</span></li><li class="c6 c0"><span>MatchMakerTopicScheduler - brokers a &lsquo;get_worker&rsquo; request, returning a hostname to create a directed topic.</span></li><li class="c6 c0"><span>MatchMakerRing - loads a static hash table from a JSON file, cycles hosts per bare topic</span><span>&nbsp;to create a directed topic.</span></li><li class="c6 c0"><span>MatchMakerFanoutRing - loads a static hash table from a JSON file, cycles hosts per bare topic.</span><span>&nbsp;Supports broker-less Fanout messaging.</span><sup><a href="#cmnt3" name="cmnt_ref3">[c]</a></sup><span>&nbsp;Normally, acts like MatchMakerRing, but on fanout messages returns an array of directed topics (messages are sent to all destinations).</span></li></ol><p class="c0 c2"><span></span></p><p class="c0 c2"><span></span></p><p class="c0"><span>To set the MatchMaker class, use option &lsquo;rpc_zmq_matchmaker&rsquo;.</span></p><p class="c0 c2"><span></span></p><p class="c0"><span>To specify the ring file for MatchMakerRing, use option &lsquo;rpc_zmq_matchmaker_ringfile&rsquo;.</span></p><p class="c0 c2"><span></span></p><h2 class="c0"><a name="h.n42nx014k7kn"></a><span>Message Broker</span><sup><a href="#cmnt4" name="cmnt_ref4">[d]</a></sup></h2><p class="c0"><span class="c7 c11">A MatchMaker capable of Broker-less fanout should be available by the April release.</span></p><p class="c0 c2"><span></span></p><p class="c0"><span>A message broker is OPTIONAL, depending on the matchmaker chosen. Some MatchMaking services also depend on a broker, but MatchMaker modules may also reduce or eliminate the requirement for a broker. Simply, the MatchMaker allows the requirement for a broker or other discovery mechanism to be pluggable.</span></p><p class="c0 c2"><span></span></p><p class="c0"><span>The IP address of this broker is set via option &lsquo;rpc_zmq_broker_ip&rsquo;. &nbsp;</span></p><h2 class="c0"><a name="h.ljwaiblqgiz5"></a><span>Message Receivers</span></h2><p class="c0 c2"><span></span></p><p class="c0"><span>Each machine running Nova, or sending RPC messages, must run the &lsquo;nova-rpc-zmq-receiver&rsquo; daemon. This receives replies to </span><span class="c5">call</span><span>&nbsp;</span><span>requests and routes responses via </span><span class="c5">IPC</span><span>&nbsp;to blocked callers.</span></p><p class="c0 c2"><span></span></p><h2 class="c0"><a name="h.txag6pl9xt9h"></a><span>Thread pool &nbsp;(OPTIONAL)</span></h2><p class="c0 c2"><span></span></p><p class="c0"><span>Each service will launch threads for incoming requests. These threads are maintained via a pool, the maximum number of threads is limited by </span><span class="c5">rpc_thread_pool_size</span><span>. The default value in Nova is 1024. (This is a common RPC configuration variable, also applicable to Kombu and Qpid)</span></p><h2 class="c0"><a name="h.b8b7osbfb0gj"></a><span>Listening Address &nbsp;(OPTIONAL)</span><sup><a href="#cmnt5" name="cmnt_ref5">[e]</a></sup></h2><p class="c0 c2"><span></span></p><p class="c0"><span>All services bind to an IP address or ethernet adapter. By default, all services bind to &lsquo;*&rsquo;, effectively binding to 0.0.0.0. &nbsp;This may be changed with the option &lsquo;rpc_zmq_bind_address&rsquo;, which accepts a wildcard, IP address, or ethernet adapter.</span></p><p class="c0 c2"><span></span></p><h2 class="c0"><a name="h.pu84ft7vpby4"></a><span>Listening Ports (OPTIONAL)</span></h2><p class="c0 c2"><span></span></p><p class="c0"><span>The ZeroMQ driver may consume an unhealthy number of TCP ports. The starting port is configured with &#39;rpc_zmq_start_port&#39;, which defaults to 9500. </span><span>Expect the driver to consume up to 50 ports, so allow and reserve ports 9500-9550 for ZeroMQ communications.</span><sup><a href="#cmnt6" name="cmnt_ref6">[f]</a></sup></p><p class="c0 c2"><span></span></p><p class="c0 c2"><span></span></p><h2 class="c0"><a name="h.182sdpnihvn7"></a><span>MatchMaker Ringfile &nbsp;(OPTIONAL)</span><sup><a href="#cmnt7" name="cmnt_ref7">[g]</a></sup></h2><p class="c0 c2"><span></span></p><p class="c0"><span>If deploying the MatchMakerRing, a ringfile is required as specified by the option &lsquo;rpc_zmq_matchmaker_ringfile&rsquo;.</span></p><p class="c0 c2"><span></span></p><h3 class="c0"><a name="h.ddugnrreg3t3"></a><span>Format</span></h3><p class="c0 c2"><span></span></p><p class="c0"><span>The MatchMaker ring is a JSON file containing a hash where each key is a base topic and the values are arrays.</span></p><p class="c0 c2"><span></span></p><p class="c0"><span>i.e.</span></p><p class="c0 c2"><span></span></p><p class="c0"><span>{</span></p><p class="c0"><span>&nbsp; &lsquo;scheduler&rsquo;: [ &ldquo;o1p409&rdquo;, &ldquo;o2p409&rdquo; ],</span></p><p class="c0"><span>&nbsp; &lsquo;network&rsquo;: [ &ldquo;o3p409&rdquo;, &ldquo;o4p409&rdquo; ]</span></p><p class="c0"><span>}</span></p><p class="c0 c2"><span></span></p><h3 class="c0"><a name="h.jcmk70f9lpjh"></a><span>Topic names</span></h3><p class="c0 c2"><span></span></p><p class="c0"><span>Base topics in the ring file must match the VALUES of the following nova flags:</span></p><p class="c0 c2"><span></span></p><p class="c0"><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;compute_topic&#39;,</span></p><p class="c0"><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;console_topic&#39;,</span></p><p class="c0"><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;scheduler_topic&#39;,</span></p><p class="c0"><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;volume_topic&#39;,</span></p><p class="c0"><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;network_topic&#39;,</span></p><p class="c0"><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;vsa_topic&#39;</span></p><p class="c0 c2"><span></span></p><p class="c0"><span>The default values of the above flags are, respectfully:</span></p><p class="c0 c2"><span></span></p><p class="c0"><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;compute&#39;,</span></p><p class="c0"><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;console&#39;,</span></p><p class="c0"><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;scheduler&#39;,</span></p><p class="c0"><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;volume&#39;,</span></p><p class="c0"><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;network&#39;,</span></p><p class="c0"><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;vsa&#39;</span></p><p class="c0 c2"><span></span></p><p class="c0"><span>It is NOT expected that we should need to provide an array of all compute machines unless we deploy nova-volume as it seems neither fanout cast nor a bare topic are used for &lsquo;compute_topic&rsquo;. &nbsp;However, the best practice would describe all applicable hosts under the &lsquo;compute&rsquo; and &lsquo;volume&rsquo; topics (if applicable) within the ring-file. This would be forward-compatible with potential Nova changes and would be safest, overall.</span></p><p class="c0 c2"><span></span></p><p class="c0 c2"><span></span></p><h2 class="c0"><a name="h.74s6itfjfn8n"></a><span>Encryption</span></h2><p class="c0 c2"><span></span></p><p class="c0"><span>Since it is asked frequently, the answer is: No, the driver does </span><span class="c7">NOT</span><span>&nbsp;encrypt communications. Discussions on how and if to implement encryption are ongoing.</span></p><p class="c0 c2"><span></span></p><p class="c0"><span>This driver should be deployed in a trusted environment.</span></p>


    
      <h2>Authors</h2>
      <p>Christopher MacGown (chris@pistoncloud.com)
<br/>Duncan McGreggor (duncan@dreamhost.com)
<br/>Eric Windisch (eric@cloudscaling.com)
<br/>Zed Shaw (zedshaw@zedshaw.com)</p>
    

    
      <h2>Contact</h2>
      <p>Eric Windisch (eric@cloudscaling.com)
<br/>      </p>
    

    <h2>Download</h2>
    <p>
      You can download this project in either
      <a href="https://github.com/ewindisch/nova/zipball/master">zip</a> or
      <a href="https://github.com/ewindisch/nova/tarball/master">tar formats.
    </p>
    <p>You can also clone the project with <a href="http://git-scm.com">Git</a>
      by running:
      <pre>$ git clone git://github.com/ewindisch/nova</pre>
    </p>

    <div class="footer">
      get the source code on GitHub : <a href="https://github.com/ewindisch/nova">ewindisch/nova</a>
    </div>

  </div>

</body>
</html>
